# Технология HTTPS, TLS-рукопожатие и применение файлов сертификата — пошагово и с деталями шифрования

## Основы защиты: как работает HTTPS и зачем нужны сертификаты

HTTPS (HTTP Secure) использует протокол TLS для шифрования данных между браузером и сервером. Основные задачи:

- **Конфиденциальность:** чтобы данные не были доступны злоумышленникам при передаче (достигается шифрованием).
- **Целостность:** чтобы данные не были подменены по дороге (контрольная сумма и хэш-функции).
- **Аутентификация:** подтверждение, что сервер — действительно тот, за кого себя выдаёт (сертификат, выданный доверенным удостоверяющим центром CA).

## Опорные файлы сертификата:

- `privkey.pem` — приватный ключ сервера (только серверу!)
- `fullchain.pem` — цепочка сертификатов (ваш + промежуточные от CA)
- `chain.pem` — только промежуточные сертификаты (CA)
- `cert.pem` — только сертификат домена (не для обычного использования в nginx)

## Детальный процесс TLS-рукопожатия и дальнейшего обмена

### 1. Установка соединения (“TLS Handshake”)

**Инициатор — клиент (браузер):**
- Отправляет серверу “Client Hello”, указывая поддерживаемые протоколы и случайное число (nonce).

**Сервер отвечает:**
- Возвращает “Server Hello” с выбранным протоколом, еще одним случайным числом и своим публичным сертификатом (`fullchain.pem`).
- (Внутри fullchain.pem: публичный ключ сервера, а также цепочка промежуточных CA, которая нужна, чтобы клиент доверял серверу.)

**Проверка подлинности:**
- Браузер проверяет подписи цепочки сертификатов, чтобы удостовериться, что публичный ключ действительно принадлежит заявленному домену и что сертификат выдан доверенным CA.

**Генерация общего секрета:**
- Используя полученный публичный ключ сервера (из fullchain.pem), клиент генерирует “pre-master secret”, шифрует его публичным ключом, присылает серверу.
- Сервер расшифровывает pre-master secret своим приватным ключом (`privkey.pem`), который хранится только на сервере.

**Вычисление симметричного ключа:**
- Оба участника независимо считают мастер-ключ (master secret) из известного им pre-master secret и nonces. Дальнейшее соединение — симметрично зашифровано (быстро и эффективно).

### 2. Защищённое соединение

Все последующие сообщения между клиентом и сервером шифруются сессионным симметричным ключом (например, AES), который никому, кроме участников сессии, не известен.

### 3. Контроль целостности

TLS встраивает криптографические хэш-функции и HMAC для проверки, не были ли сообщения случайно или намеренно изменены (подделка невозможна без знания секретного ключа).

### 4. Аутентификация и электронная подпись

**Для подтверждения авторства сообщений:**
- Электронная подпись реализуется с помощью приватного ключа: сервер может “подписывать” (например, хэши handshake-сообщений), а клиент может проверить подпись публичным ключом из сертификата.

**Роль удостоверяющего центра (CA):**
- Цепочка сертификации (fullchain.pem) позволяет браузеру быть уверенным, что публичный ключ действительно принадлежит именно этому серверу, а не злоумышленнику.

---

## Мост между теорией и практикой (на основе приложения)

1. Приватный ключ (`privkey.pem`) играет роль “секретного” — ВСЕ шифрования и подписи на стороне сервера делаются только с ним, никогда не покидает сервер!
2. “fullchain.pem” передается клиенту, чтобы клиент мог проверить доверие (то есть принадлежит ли этот ключ именно серверу и подтверждён ли цепочкой CA).
3. Симметричный ключ для шифрования сессии вырабатывается в процессе “рукопожатия” — никто кроме клиента и сервера узнать его не может, итог: данные между ними приватны.
4. Электронные подписи и контроль целостности обеспечивают, что подделать или искажать данные невозможно, не обладая нужными ключами.
5. Если злоумышленник просто “слушает” канал — он не сможет узнать содержимое (нет ключа). Если пытается “подделать” сообщения — контрольная сумма и подписи покажут, что что-то не так.

---

## Визуализация (последовательно для каждого этапа):

1. **Браузер подключается → Сервер шлет сертификат (fullchain)**
2. **Браузер проверяет сертификат**
3. **Браузер генерирует секрет и шифрует его публичным ключом (из сертификата)**
4. **Сервер расшифровывает секрет своим приватным ключом**
5. **Стороны пересчитывают сессионный симметричный ключ, используют его для дальнейшего шифрования**
6. **Всё, что отправляется дальше, — зашифровано и защищено электронной подписью/контролем целостности**

---

## Итог

- Технология сочетает симметричное и асимметричное шифрование, хэши и цифровые подписи.
- Сертификат и файлы Let's Encrypt — практическая реализация этих принципов для вашего сайта.
- Современный HTTPS — это и шифрование, и идентификация, и контроль целостности, построенные на описанных в вашем файле криптографических основах.
